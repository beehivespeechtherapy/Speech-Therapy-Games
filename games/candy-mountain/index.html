<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Candy Mountain</title>
  <link rel="stylesheet" href="../../core/styles.css">
  <style>
    body.candy-mountain-game #game-map {
      width: min(90vw, 90vh) !important;
      height: min(90vw, 90vh) !important;
      max-width: min(90vw, 90vh) !important;
      max-height: 90vh !important;
      background-size: contain !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
    }
    #choose-screen {
      position: fixed; inset: 0; z-index: 100;
      background: linear-gradient(180deg, #87CEEB 0%, #98D8C8 100%);
      display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      padding: 1.5rem; overflow-y: auto;
    }
    #choose-screen.hidden { display: none; }
    #choose-screen h2 { font-size: 1.35rem; color: #333; margin-bottom: 0.5rem; text-align: center; }
    #choose-screen p { color: #555; margin-bottom: 1rem; text-align: center; }
    .word-set-list { display: flex; flex-direction: column; gap: 0.75rem; max-width: 520px; width: 100%; margin: 0 auto; }
    .word-set-btn {
      background: #fff; border: 3px solid var(--secondary-color, #FF9800);
      border-radius: 12px; padding: 1rem 1.25rem; font-size: 1rem; color: #333;
      text-align: left; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .word-set-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
    .candy-marker { cursor: pointer; }
    .candy-marker image,
    .candy-marker text {
      filter: drop-shadow(0 0 3px #fff) drop-shadow(0 0 6px rgba(255,255,255,0.9));
    }
    .candy-marker.collected { display: none; }
    .candy-marker.not-next { cursor: default; pointer-events: none; }
    /* Hide path line and waypoint circles so only candies show */
    body.candy-mountain-game #game-map .path-line { display: none; }
    body.candy-mountain-game #game-map .waypoint { display: none; }
    /* Protagonist 4Ã— original (twice as big as previous 2Ã—); size + translate so center stays on path (animator uses 60x60 at checkpoint-30) */
    body.candy-mountain-game #game-map .protagonist-svg-image {
      width: 240px;
      height: 240px;
      transform: translate(-90px, -90px);
    }
  </style>
</head>
<body class="candy-mountain-game">
  <div id="game-container">
    <div id="choose-screen">
      <h2>Candy Mountain</h2>
      <p>Pick up 12 candies! Choose which word pairs to practice, then click each candy to answer.</p>
      <div id="word-set-list" class="word-set-list"></div>
    </div>
    <section class="map-section fullscreen">
      <div id="game-map"></div>
    </section>
    <div id="challenge-modal" class="modal challenge-modal hidden">
      <div class="modal-content challenge-content">
        <h2 id="challenge-prompt">Choose the correct word:</h2>
        <div id="word-pairs" class="pair-container"></div>
      </div>
    </div>
    <div id="victory-modal" class="modal victory-modal hidden">
      <div class="modal-content">
        <h1>Victory!</h1>
        <p id="victory-message"></p>
        <button id="play-again">Play Again</button>
      </div>
    </div>
  </div>

  <script type="application/json" id="game-config">
  {"title":"Candy Mountain","description":"Pick up 12 pieces of candy! At each candy, choose the correct word. Click a candy to start.","targetSound":"k","contrastSound":"t","wrongAnswerMovesBack":false,"protagonist":{"character":"explorer","images":{"idle":"assets/protagonist/idle.png","walking":"assets/protagonist/idle.png","celebrating":"assets/protagonist/celebrating.png"}},"map":{"theme":"candy mountain","backgroundImage":"../../assets/maps/candymountain.png","waypoints":[{"x":80,"y":80},{"x":144,"y":175},{"x":482,"y":232},{"x":482,"y":327},{"x":264,"y":411},{"x":528,"y":447},{"x":749,"y":530},{"x":530,"y":605},{"x":277,"y":657},{"x":187,"y":792},{"x":355,"y":841},{"x":553,"y":828},{"x":776,"y":890},{"x":889,"y":911}],"viewBoxWidth":1024,"viewBoxHeight":1024},"challenges":[{"id":1,"correctWord":"can","correctSound":"k","pairs":[{"word":"can","sound":"k","image":"assets/pairs/can.png","alt":"can"},{"word":"tan","sound":"t","image":"assets/pairs/tan.png","alt":"tan"}]},{"id":2,"correctWord":"cap","correctSound":"k","pairs":[{"word":"cap","sound":"k","image":"assets/pairs/cap.png","alt":"cap"},{"word":"tap","sound":"t","image":"assets/pairs/tap.png","alt":"tap"}]},{"id":3,"correctWord":"cape","correctSound":"k","pairs":[{"word":"cape","sound":"k","image":"assets/pairs/cape.png","alt":"cape"},{"word":"tape","sound":"t","image":"assets/pairs/tape.png","alt":"tape"}]},{"id":4,"correctWord":"car","correctSound":"k","pairs":[{"word":"car","sound":"k","image":"assets/pairs/car.jpg","alt":"car"},{"word":"tar","sound":"t","image":"assets/pairs/tar.jpg","alt":"tar"}]},{"id":5,"correctWord":"cart","correctSound":"k","pairs":[{"word":"cart","sound":"k","image":"assets/pairs/cart.png","alt":"cart"},{"word":"tart","sound":"t","image":"assets/pairs/tart.png","alt":"tart"}]},{"id":6,"correctWord":"cod","correctSound":"k","pairs":[{"word":"cod","sound":"k","image":"assets/pairs/cod.png","alt":"cod"},{"word":"todd","sound":"t","image":"assets/pairs/todd.png","alt":"todd"}]},{"id":7,"correctWord":"code","correctSound":"k","pairs":[{"word":"code","sound":"k","image":"assets/pairs/code.png","alt":"code"},{"word":"toad","sound":"t","image":"assets/pairs/toad.png","alt":"toad"}]},{"id":8,"correctWord":"cop","correctSound":"k","pairs":[{"word":"cop","sound":"k","image":"assets/pairs/cop.png","alt":"cop"},{"word":"top","sound":"t","image":"assets/pairs/top.png","alt":"top"}]},{"id":9,"correctWord":"core","correctSound":"k","pairs":[{"word":"core","sound":"k","image":"assets/pairs/core.png","alt":"core"},{"word":"tore","sound":"t","image":"assets/pairs/tore.png","alt":"tore"}]},{"id":10,"correctWord":"cub","correctSound":"k","pairs":[{"word":"cub","sound":"k","image":"assets/pairs/cub.png","alt":"cub"},{"word":"tub","sound":"t","image":"assets/pairs/tub.png","alt":"tub"}]},{"id":11,"correctWord":"ken","correctSound":"k","pairs":[{"word":"ken","sound":"k","image":"assets/pairs/ken.png","alt":"ken"},{"word":"ten","sound":"t","image":"assets/pairs/ten.png","alt":"ten"}]},{"id":12,"correctWord":"key","correctSound":"k","pairs":[{"word":"key","sound":"k","image":"assets/pairs/key.png","alt":"key"},{"word":"tea","sound":"t","image":"assets/pairs/tea.png","alt":"tea"}]}],"victory":{"message":"You collected all 12 candies! Great job!","music":"../../assets/audio/victory.mp3"},"wordSets":[{"id":"candy-default","label":"T/K Minimal Pairs - Initial (default)","prompt":"Which word has the /k/ sound?","targetSound":"k","contrastSound":"t","pairs":[["can","tan"],["cap","tap"],["cape","tape"],["car","tar"],["cart","tart"],["cod","todd"],["code","toad"],["cop","top"],["core","tore"],["cub","tub"],["ken","ten"],["key","tea"]]},{"id":"tk-k1","label":"T/K Minimal Pairs - Initial K","prompt":"Which word has the /k/ sound?","targetSound":"k","contrastSound":"t","pairs":[["can","tan"],["cap","tap"],["cape","tape"],["car","tar"],["cart","tart"],["cod","todd"],["code","toad"],["cop","top"],["core","tore"],["cub","tub"]]},{"id":"tk-t1","label":"T/K Minimal Pairs - Initial T","prompt":"Which word has the /t/ sound?","targetSound":"t","contrastSound":"k","pairs":[["tan","can"],["tap","cap"],["tape","cape"],["tar","car"],["tart","cart"],["todd","cod"],["toad","code"],["top","cop"],["tore","core"],["tub","cub"]]},{"id":"tk-k2","label":"T/K Minimal Pairs - Final K","prompt":"Which word has the /k/ sound?","targetSound":"k","contrastSound":"t","pairs":[["back","bat"],["beak","beet"],["bike","bite"],["hike","height"],["kick","kit"],["lick","lit"],["lock","lot"],["pick","pit"],["puck","putt"],["rack","rat"]]},{"id":"tk-t2","label":"T/K Minimal Pairs - Final T","prompt":"Which word has the /t/ sound?","targetSound":"t","contrastSound":"k","pairs":[["bat","back"],["beet","beak"],["bite","bike"],["height","hike"],["kit","kick"],["lit","lick"],["lot","lock"],["pit","pick"],["putt","puck"],["rat","rack"]]},{"id":"dg-d1","label":"D/G Minimal Pairs - Initial D","prompt":"Which word has the /d/ sound?","targetSound":"d","contrastSound":"g","pairs":[["dame","game"],["date","gate"],["dawn","gone"],["deer","gear"],["doe","go"],["done","gun"],["dot","got"],["down","gown"],["dust","gust"],["dye","guy"]]},{"id":"dg-g1","label":"D/G Minimal Pairs - Initial G","prompt":"Which word has the /g/ sound?","targetSound":"g","contrastSound":"d","pairs":[["game","dame"],["gate","date"],["gone","dawn"],["gear","deer"],["go","doe"],["gun","done"],["got","dot"],["gown","down"],["gust","dust"],["guy","dye"]]},{"id":"dg-g2","label":"D/G Minimal Pairs - Final G","prompt":"Which word has the /g/ sound?","targetSound":"g","contrastSound":"d","pairs":[["bag","bad"],["beg","bed"],["bug","bud"],["dig","did"],["egg","Ed"],["hag","had"],["leg","lead"],["mug","mud"],["rag","rad"],["tag","tad"]]},{"id":"dg-d2","label":"D/G Minimal Pairs - Final D","prompt":"Which word has the /d/ sound?","targetSound":"d","contrastSound":"g","pairs":[["bad","bag"],["bed","beg"],["bud","bug"],["did","dig"],["Ed","egg"],["had","hag"],["lead","leg"],["mud","mug"],["rad","rag"],["tad","tag"]]},{"id":"vb-b1","label":"V/B Minimal Pairs - Initial B","prompt":"Which word has the /b/ sound?","targetSound":"b","contrastSound":"v","pairs":[["ban","van"],["best","vest"],["broom","vroom"],["boat","vote"],["base","vase"],["bale","veil"],["berry","very"],["bow","vow"],["bent","vent"],["bat","vat"]]},{"id":"vb-v1","label":"V/B Minimal Pairs - Initial V","prompt":"Which word has the /v/ sound?","targetSound":"v","contrastSound":"b","pairs":[["veil","bale"],["vase","base"],["vat","bat"],["vent","bent"],["very","berry"],["vest","best"],["vote","boat"],["view","boo"],["vroom","broom"]]},{"id":"vb-v2","label":"V/B Minimal Pairs - Final V","prompt":"Which word has the /v/ sound?","targetSound":"v","contrastSound":"b","pairs":[["carve","carb"],["curve","curb"],["wave","web"],["drive","drib"],["five","fib"],["give","goob"],["grave","grab"],["live","lab"],["love","lobe"],["nerve","nub"]]},{"id":"vb-b2","label":"V/B Minimal Pairs - Final B","prompt":"Which word has the /b/ sound?","targetSound":"b","contrastSound":"v","pairs":[["carb","carve"],["curb","curve"],["drib","drive"],["fib","five"],["goob","give"],["grab","grave"],["lab","live"],["lobe","love"],["nub","nerve"]]}]}
  </script>
  <script src="../../core/engine.js"></script>
  <script src="../../core/ui.js"></script>
  <script src="../../core/animator.js"></script>
  <script src="../../core/audio.js"></script>

  <script>
    const engine = new GameEngine('./config.json');
    const ui = new GameUI(document.getElementById('game-container'));
    const animator = new PathAnimator(ui);
    const audio = new AudioManager();
    const NUM_CANDIES = 12;
    let isProcessing = false;
    let candyElements = [];

    const WORD_SET_FOLDERS = {
      'candy-default': 'T:K Minimal Pairs - Initial',
      'tk-k1': 'T:K Minimal Pairs - Initial', 'tk-t1': 'T:K Minimal Pairs - Initial',
      'tk-k2': 'T:K Minimal Pairs - Final', 'tk-t2': 'T:K Minimal Pairs - Final',
      'dg-d1': 'D:G Minimal Pairs - Initial', 'dg-g1': 'D:G Minimal Pairs - Initial',
      'dg-d2': 'D:G Minimal Pairs - Final', 'dg-g2': 'D:G Minimal Pairs - Final',
      'vb-b1': 'V:B Minimal Pairs - Initial', 'vb-v1': 'V:B Minimal Pairs - Initial',
      'vb-b2': 'V:B Minimal Pairs - Final', 'vb-v2': 'V:B Minimal Pairs - Final'
    };

    function wordImagesRoot() {
      const path = window.location.pathname.replace(/\/games\/[^/]+(\/.*)?$/, '');
      return window.location.origin + (path.endsWith('/') ? path : path + '/');
    }

    function pairImagePath(word, setId) {
      const file = (word === 'v' || word === 'V') ? 'v' : (word === 'Ed') ? 'Ed' : word.toLowerCase();
      const filename = file + '.png';
      const folder = setId && WORD_SET_FOLDERS[setId];
      if (folder) {
        const encodedFolder = encodeURIComponent(folder).replace(/%2F/g, '/');
        try {
          return new URL('word-images/' + encodedFolder + '/' + filename, wordImagesRoot()).href;
        } catch (e) {
          return '../../word-images/' + encodedFolder + '/' + filename;
        }
      }
      return 'assets/pairs/' + filename;
    }

    function buildChallengesFromWordSet(set) {
      const pairs = set.pairs || [];
      const targetSound = set.targetSound || 'k';
      const contrastSound = set.contrastSound || 't';
      const setId = set.id;
      const challenges = [];
      for (let i = 0; i < NUM_CANDIES; i++) {
        const pair = pairs[i % pairs.length];
        const targetWord = pair[0];
        const contrastWord = pair[1];
        challenges.push({
          id: i + 1,
          correctWord: targetWord,
          correctSound: targetSound,
          pairs: [
            { word: targetWord, sound: targetSound, image: pairImagePath(targetWord, setId), alt: targetWord },
            { word: contrastWord, sound: contrastSound, image: pairImagePath(contrastWord, setId), alt: contrastWord }
          ]
        });
      }
      return challenges;
    }

    function showChooseScreen() {
      const list = document.getElementById('word-set-list');
      const chooseScreen = document.getElementById('choose-screen');
      if (!list || !chooseScreen) return;
      const sets = engine.config.wordSets || [];
      list.innerHTML = '';
      sets.forEach((set) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'word-set-btn';
        btn.textContent = set.label;
        btn.addEventListener('click', () => {
          engine.config.challenges = buildChallengesFromWordSet(set);
          chooseScreen.classList.add('hidden');
          startMapAndCandies();
        });
        list.appendChild(btn);
      });
    }

    function applyCustomWaypoints() {
      const totalChallenges = engine.config.challenges.length;
      const needWp = totalChallenges + 1;
      let mapCfg = engine.config.map || {};
      let rawWp = mapCfg.waypoints;
      if (!Array.isArray(rawWp) || rawWp.length < needWp) {
        const el = document.getElementById('game-config');
        if (el && el.textContent) {
          try {
            const c = JSON.parse(el.textContent.trim());
            mapCfg = c.map || {};
            rawWp = mapCfg.waypoints;
          } catch (e) {}
        }
      }
      const wp = Array.isArray(rawWp) ? rawWp.slice(0, needWp) : null;
      if (!wp || wp.length < needWp) return;
      const mapEl = document.getElementById('game-map');
      if (!mapEl) return;
      const vw = Number(mapCfg.viewBoxWidth) || 1024;
      const vh = Number(mapCfg.viewBoxHeight) || 1024;
      const pts = wp.map(p => ({ x: Number(p.x), y: Number(p.y) }));
      const svg = mapEl.firstElementChild && (mapEl.firstElementChild.tagName || '').toLowerCase() === 'svg' ? mapEl.firstElementChild : mapEl.querySelector('svg');
      if (!svg || !pts.length) return;
      try {
        svg.setAttribute('viewBox', '0 0 ' + vw + ' ' + vh);
        const path = svg.querySelector('path');
        if (path) {
          let d = 'M ' + pts[0].x + ',' + pts[0].y;
          for (let i = 1; i < pts.length; i++) d += ' L ' + pts[i].x + ',' + pts[i].y;
          path.setAttribute('d', d);
        }
        const circles = Array.from(svg.querySelectorAll('circle'));
        circles.forEach((circle, i) => {
          if (pts[i]) { circle.setAttribute('cx', pts[i].x); circle.setAttribute('cy', pts[i].y); }
        });
        const flagText = svg.querySelector('text');
        if (flagText && pts[pts.length - 1]) {
          flagText.setAttribute('x', pts[pts.length - 1].x);
          flagText.setAttribute('y', pts[pts.length - 1].y - 25);
        }
        ui.checkpoints = pts;
      } catch (e) { console.warn('Custom waypoints failed', e); }
    }

    function candyImageUrl(i) {
      const base = window.location.href.replace(/[^/]+$/, '');
      return base + 'assets/candy/candy' + i + '.png';
    }

    function addCandyMarkers(svg, checkpoints) {
      const ns = 'http://www.w3.org/2000/svg';
      const candyGroup = document.createElementNS(ns, 'g');
      candyGroup.setAttribute('class', 'candy-markers');
      const size = 48;
      const offset = size / 2;
      for (let i = 1; i <= NUM_CANDIES; i++) {
        const pt = checkpoints[i];
        if (!pt) continue;
        const g = document.createElementNS(ns, 'g');
        g.setAttribute('class', 'candy-marker');
        g.setAttribute('data-candy-index', i);
        const img = document.createElementNS(ns, 'image');
        img.setAttribute('href', candyImageUrl(i));
        img.setAttribute('x', pt.x - offset);
        img.setAttribute('y', pt.y - offset);
        img.setAttribute('width', size);
        img.setAttribute('height', size);
        img.setAttribute('preserveAspectRatio', 'xMidYMid meet');
        img.addEventListener('error', function () {
          const text = document.createElementNS(ns, 'text');
          text.setAttribute('x', pt.x);
          text.setAttribute('y', pt.y);
          text.setAttribute('text-anchor', 'middle');
          text.setAttribute('dominant-baseline', 'middle');
          text.setAttribute('font-size', '28');
          text.textContent = 'ðŸ¬';
          g.appendChild(text);
        });
        g.appendChild(img);
        candyGroup.appendChild(g);
        candyElements.push(g);
      }
      svg.appendChild(candyGroup);
      updateCandyClickability();
    }

    function updateCandyClickability(wentBack) {
      const pos = engine.currentPosition;
      const nextIndex = pos + 1;
      candyElements.forEach((el, i) => {
        const index = i + 1;
        el.classList.remove('collected', 'not-next');
        if (wentBack) {
          if (index < pos) el.classList.add('collected');
          else if (index > nextIndex) el.classList.add('not-next');
        } else {
          if (index <= pos) el.classList.add('collected');
          else if (index > nextIndex) el.classList.add('not-next');
        }
      });
    }

    function startMapAndCandies() {
      const totalChallenges = engine.config.challenges.length;
      const mapConfig = {
        ...(engine.config.map || {}),
        protagonist: engine.config.protagonist
      };
      ui.renderMap(totalChallenges, engine.currentPosition, mapConfig);
      applyCustomWaypoints();
      animator.init();
      const mapEl = document.getElementById('game-map');
      const svg = mapEl && (mapEl.firstElementChild && (mapEl.firstElementChild.tagName || '').toLowerCase() === 'svg' ? mapEl.firstElementChild : mapEl.querySelector('svg'));
      candyElements = [];
      if (svg && ui.checkpoints && ui.checkpoints.length >= NUM_CANDIES + 1) {
        addCandyMarkers(svg, ui.checkpoints);
        candyElements.forEach((g, i) => {
          const index = i + 1;
          g.addEventListener('click', () => {
            if (engine.currentPosition + 1 !== index) return;
            if (isProcessing) return;
            openChallengeForCandy();
          });
        });
      }
    }

    function openChallengeForCandy() {
      const challenge = engine.getCurrentChallenge();
      if (!challenge) return;
      ui.renderChallenge(challenge, engine.config);
      ui.showChallengeModal();
    }

    async function initGame() {
      try {
        await engine.loadConfig();
        document.title = engine.config.title || 'Candy Mountain';
        ui.init();
        if (engine.config.victory && engine.config.victory.music) {
          audio.init(engine.config.victory.music);
        }
        setupEventHandlers();
        document.addEventListener('click', () => audio.unlockAudio(), { once: true });

        const wordSets = engine.config.wordSets || [];
        if (wordSets.length > 0) {
          showChooseScreen();
          return;
        }
        engine.config.challenges = engine.config.challenges || [];
        document.getElementById('choose-screen').classList.add('hidden');
        startMapAndCandies();
      } catch (error) {
        console.error('Failed to initialize game:', error);
        alert('Failed to load game. Please check the console for details.');
      }
    }

    function setupEventHandlers() {
      ui.onAnswer(async (choiceIndex) => {
        if (isProcessing) return;
        isProcessing = true;
        const result = await engine.submitAnswer(choiceIndex);
        ui.showFeedback(result.correct);
        await new Promise(r => setTimeout(r, 800));
        ui.hideChallengeModal();
        await new Promise(r => setTimeout(r, 400));

        if (result.correct) {
          if (engine.currentPosition > 0) animator.playForwardFeedback();
          await animator.moveToPosition(result.newPosition, 800);
          updateCandyClickability(false);
        } else {
          ui.showTemporaryMessage('Try again! Click the candy when you\'re ready.', false);
          await new Promise(r => setTimeout(r, 600));
        }
        await new Promise(r => setTimeout(r, 400));

        if (engine.isVictory()) {
          await handleVictory();
        }
        isProcessing = false;
      });

      ui.onPlayAgain(() => {
        engine.reset();
        ui.hideVictory();
        if (engine.config.wordSets && engine.config.wordSets.length > 0) {
          document.getElementById('choose-screen').classList.remove('hidden');
          showChooseScreen();
        } else {
          startMapAndCandies();
        }
      });
    }

    async function handleVictory() {
      await ui.showVictory(engine.config);
      await audio.playVictory();
    }

    initGame();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Candy Mountain</title>

  <!-- Core framework styles -->
  <link rel="stylesheet" href="../../core/styles.css">

  <style>
    /* Game-specific: none needed for now */
  </style>
</head>
<body>
  <div id="game-container">
    <section class="map-section fullscreen">
      <div id="game-map"></div>
    </section>

    <div id="challenge-modal" class="modal challenge-modal hidden">
      <div class="modal-content challenge-content">
        <h2 id="challenge-prompt">Choose the correct word:</h2>
        <div id="word-pairs" class="pair-container"></div>
      </div>
    </div>

    <div id="victory-modal" class="modal victory-modal hidden">
      <div class="modal-content">
        <h1>Victory!</h1>
        <div id="victory-gif-container">
          <img id="victory-gif" src="" alt="Celebration!" />
        </div>
        <p id="victory-message"></p>
        <button id="play-again">Play Again</button>
      </div>
    </div>
  </div>

  <script src="../../core/engine.js"></script>
  <script src="../../core/ui.js"></script>
  <script src="../../core/animator.js"></script>
  <script src="../../core/audio.js"></script>

  <script>
    const engine = new GameEngine('./config.json');
    const ui = new GameUI(document.getElementById('game-container'));
    const animator = new PathAnimator(ui);
    const audio = new AudioManager();
    let isProcessing = false;

    async function initGame() {
      try {
        await engine.loadConfig();
        document.title = engine.config.title || 'Candy Mountain';
        ui.init();
        if (engine.config.victory && engine.config.victory.music) {
          audio.init(engine.config.victory.music);
        }
        renderGame();
        setupEventHandlers();
        document.addEventListener('click', () => audio.unlockAudio(), { once: true });
      } catch (error) {
        console.error('Failed to initialize game:', error);
        alert('Failed to load game. Please check the console for details.');
      }
    }

    async function renderGame(showChallengeDelay = 1500) {
      const challenge = engine.getCurrentChallenge();
      if (challenge) {
        const totalChallenges = engine.config.challenges.length;
        const mapConfig = {
          ...(engine.config.map || {}),
          protagonist: engine.config.protagonist
        };
        ui.renderMap(totalChallenges, engine.currentPosition, mapConfig);
        animator.init();
        await new Promise(resolve => setTimeout(resolve, showChallengeDelay));
        ui.renderChallenge(challenge, engine.config);
      } else if (engine.isVictory()) {
        handleVictory();
      }
    }

    function setupEventHandlers() {
      ui.onAnswer(async (choiceIndex) => {
        if (isProcessing) return;
        isProcessing = true;
        const result = await engine.submitAnswer(choiceIndex);
        ui.showFeedback(result.correct);
        await new Promise(resolve => setTimeout(resolve, 800));
        ui.hideChallengeModal();
        await new Promise(resolve => setTimeout(resolve, 400));
        if (result.correct && engine.currentPosition > 0) {
          animator.playForwardFeedback();
        } else if (!result.correct) {
          animator.playBackwardFeedback();
        }
        await animator.moveToPosition(result.newPosition, 800);
        await new Promise(resolve => setTimeout(resolve, 800));
        if (engine.isVictory()) {
          await handleVictory();
        } else {
          await renderGame(1000);
        }
        isProcessing = false;
      });

      ui.onPlayAgain(() => {
        engine.reset();
        ui.hideVictory();
        renderGame();
      });
    }

    async function handleVictory() {
      await animator.celebrate();
      await ui.showVictory(engine.config);
      await audio.playVictory();
    }

    initGame();
  </script>
</body>
</html>
